<!DOCTYPE html>
<html>

  <head>
    <link rel="stylesheet" href="./lib/css/styles.css">
  </head>

  <body>
    <div class="grid-container">
      <header class="header">
        <div>
          MELD Score and 3 Month Mortality Percentage Calculator 
          <div>Patient Name:
          <span class="banner-value" id="patient_name">..</span>
          Gender:
          <span class="banner-value" id="gender">..</span>
          DOB:
          <span class="banner-value" id="dob">..</span>
        </div></div>
      </header>

      <main class="main">
        <div class="big-card">
          <div class="card">
            <div class="title">
              Retrieves EHR data for Bilirubin, Creatinine, INR, and Sodium.
            </div>
            <div class="title">
              This data is used to calculate MELD score. Meld Score correlates to pre-determined mortality percentages. These percentages predict the probability of the patient expiring within 3 months.
            </div>
            <div class="title">
              Meld Score (MLD) = (9.57 x ln(Creatinine) + 3.78 x ln(bilirubin) + 11.20 x ln(INR) + 6.43) * 10
            </div>
            <div class="title">
              If MLD > 11, then Meld Score = MLD + 1.32 x (137 - Sodium) - [0.033 x MLD x (137 - Sodium)]
            </div>
            <div class="second">
              Use 1.0 for Bilirubin, Creatinine, and/or INR effective measure if below 1.0
            </div>
            <div class="second">
              Use 4.0 for Creatinine effective measure if > 4.0
            </div>
            <div class="second">
              125 &lt; Effective Sodium &lt; 137
            </div>
          </div>
          <div class="card">
            <div class="title">3-Month Mortality Based on Meld Score</div>
            <div style="direction: ltr;">
              <table style="direction: ltr; border-collapse: collapse; border: 1pt solid #A3A3A3;" title="" border="1" summary="" cellspacing="0" cellpadding="0">
              <tbody>
              <tr>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .9673in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;"><span style="font-weight: bold;">MELD Score</span></p>
              </td>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .7326in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;"><span style="font-weight: bold;">Mortality</span></p>
              </td>
              </tr>
              <tr>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .9479in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;">&le;9</p>
              </td>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .6826in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;">1.9%</p>
              </td>
              </tr>
              <tr>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .9479in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;">10&ndash;19</p>
              </td>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .6826in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;">6.0%</p>
              </td>
              </tr>
              <tr>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .9479in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;">20&ndash;29</p>
              </td>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .6826in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;">19.6%</p>
              </td>
              </tr>
              <tr>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .9479in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;">30&ndash;39</p>
              </td>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .6826in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;">52.6%</p>
              </td>
              </tr>
              <tr>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .9479in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;">&ge;40</p>
              </td>
              <td style="background-color: #f0f0f0; vertical-align: top; width: .6826in; padding: 4pt 4pt 4pt 4pt; border: 1pt solid #A3A3A3;">
              <p style="margin-top: 3pt; margin-bottom: 3pt; font-family: Facit; font-size: 10.9pt; color: #2c2c2c;">71.3%</p>
              </td>
              </tr>
              </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="big-card">
          <div class="card">
            
            <div class="title">Test Different Values By Dragging Sliders</div>
            <div class="slidecontainer">
              <p>Bilirubin Value (mg/dL): <span id="bilival"></span></p>
              <input type="range" min="1" max="50" value="1" step="0.5" class="slider" id="bilislider">
            </div>
            <script>
              var slider = document.getElementById("bilislider");
              var output = document.getElementById("bilival");
              output.innerHTML = slider.value;
              slider.oninput = function() {
                bilival.innerHTML = this.value;
                var meld = Math.round(10*(0.957*Math.log(document.getElementById("creatval").innerHTML)+0.378*Math.log(document.getElementById("bilival").innerHTML)+1.120*Math.log(document.getElementById("inrval").innerHTML)+0.643))/10*10;
                
                if (meld > 11){
                  meld = Math.round(meld+1.32*(137-document.getElementById("sodval").innerHTML)-(0.033*meld*(137-document.getElementById("sodval").innerHTML)));
                    if (meld > 40){
                      meld = 40;
                    }
                }
                var mort = 0;
                if (meld == 0){
                  mort = "0";
                }else if (meld < 10){
                  mort = "1.9%";
                }else if (meld < 20){
                  mort = "6.0%";
                }else if (meld < 30){
                  mort = "19.6%";
                }else if (meld < 40){
                  mort = "52.6%";
                }else{
                  mort = "71.3%";
                }

                document.getElementById('meldcalc').innerHTML = meld;
                document.getElementById('mortcalc').innerHTML = mort;
              }
            </script>
          
            <div class="slidecontainer">
              <p>INR Value: <span id="inrval"></span></p>
              <input type="range" min="1" max="20" value="1" step="0.5" class="slider" id="inrslider">
            </div>
            <script>
              var slider = document.getElementById("inrslider");
              var output = document.getElementById("inrval");
              output.innerHTML = slider.value;
              slider.oninput = function() {
                inrval.innerHTML = this.value;
                var meld = Math.round(10*(0.957*Math.log(document.getElementById("creatval").innerHTML)+0.378*Math.log(document.getElementById("bilival").innerHTML)+1.120*Math.log(document.getElementById("inrval").innerHTML)+0.643))/10*10;
                
                if (meld > 11){
                  meld = Math.round(meld+1.32*(137-document.getElementById("sodval").innerHTML)-(0.033*meld*(137-document.getElementById("sodval").innerHTML)));
                    if (meld > 40){
                      meld = 40;
                    }
                }
                var mort = 0;
                if (meld == 0){
                  mort = "0";
                }else if (meld < 10){
                  mort = "1.9%";
                }else if (meld < 20){
                  mort = "6.0%";
                }else if (meld < 30){
                  mort = "19.6%";
                }else if (meld < 40){
                  mort = "52.6%";
                }else{
                  mort = "71.3%";
                }

                document.getElementById('meldcalc').innerHTML = meld;
                document.getElementById('mortcalc').innerHTML = mort;
              }
            </script>
            
            <div class="slidecontainer">
              <p>Creatinine Value (mg/dL): <span id="creatval"></span></p>
              <input type="range" min="1" max="4" value="1" step="0.1" class="slider" id="creatslider">
            </div>
            <script>
              var slider = document.getElementById("creatslider");
              var output = document.getElementById("creatval");
              output.innerHTML = slider.value;
              slider.oninput = function() {
                creatval.innerHTML = this.value;
                var meld = Math.round(10*(0.957*Math.log(document.getElementById("creatval").innerHTML)+0.378*Math.log(document.getElementById("bilival").innerHTML)+1.120*Math.log(document.getElementById("inrval").innerHTML)+0.643))/10*10;
                
                if (meld > 11){
                  meld = Math.round(meld+1.32*(137-document.getElementById("sodval").innerHTML)-(0.033*meld*(137-document.getElementById("sodval").innerHTML)));
                    if (meld > 40){
                      meld = 40;
                    }
                }
                var mort = 0;
                if (meld == 0){
                  mort = "0";
                }else if (meld < 10){
                  mort = "1.9%";
                }else if (meld < 20){
                  mort = "6.0%";
                }else if (meld < 30){
                  mort = "19.6%";
                }else if (meld < 40){
                  mort = "52.6%";
                }else{
                  mort = "71.3%";
                }

                document.getElementById('meldcalc').innerHTML = meld;
                document.getElementById('mortcalc').innerHTML = mort;
              }
            </script>

            <div class="slidecontainer">
              <p>Sodium Value (mmol/L): <span id="sodval"></span></p>
              <input type="range" min="125" max="137" value="125" step="0.5" class="slider" id="sodslider">
            </div>
            <script>
              var slider = document.getElementById("sodslider");
              var output = document.getElementById("sodval");
              output.innerHTML = slider.value;
              slider.oninput = function() {
                sodval.innerHTML = this.value;

                var meld = Math.round(10*(0.957*Math.log(document.getElementById("creatval").innerHTML)+0.378*Math.log(document.getElementById("bilival").innerHTML)+1.120*Math.log(document.getElementById("inrval").innerHTML)+0.643))/10*10;
                
                if (meld > 11){
                  meld = Math.round(meld+1.32*(137-document.getElementById("sodval").innerHTML)-(0.033*meld*(137-document.getElementById("sodval").innerHTML)));
                    if (meld > 40){
                      meld = 40;
                    }
                }
                var mort = 0;
                if (meld == 0){
                  mort = "0";
                }else if (meld < 10){
                  mort = "1.9%";
                }else if (meld < 20){
                  mort = "6.0%";
                }else if (meld < 30){
                  mort = "19.6%";
                }else if (meld < 40){
                  mort = "52.6%";
                }else{
                  mort = "71.3%";
                }

                document.getElementById('meldcalc').innerHTML = meld;
                document.getElementById('mortcalc').innerHTML = mort;
                
              }
            </script>
              

            <div class="title">Calculated MELD Score: <span id="meldcalc">6</span></div>
            <div class="title">Calculated Mortality:  <span id="mortcalc">1.9%</span></div>
            <div class="title">Enter Date YYYY-MM-DD: <input type="text" size="20" id="newday"/></div>
            
            <button class="annotation-button" id="send2table">Send Values To Table!</button>
            <script type="text/javascript">

              document.getElementById("send2table").addEventListener("click", sendToTable);
              function sendToTable (){
                var table = document.getElementById("meastable")
                var row= document.createElement("tr");

                var mdate = document.createElement("td");
                var bildata = document.createElement("td");
                var creatdata = document.createElement("td"); 
                var inrdata = document.createElement("td");
                var sodidata = document.createElement("td");
                var melddata = document.createElement("td"); 

                sstring = "<input type=\"text\" size=\"7.5\" oninput = \"update(this, this.value)\" value=\""
                estring = "\"/>"
                mdate.innerHTML = sstring + document.getElementById("newday").value + estring;
                bildata.innerHTML = sstring + document.getElementById("bilislider").value + estring;
                creatdata.innerHTML = sstring + document.getElementById("creatslider").value + estring;
                inrdata.innerHTML = sstring + document.getElementById("inrslider").value + estring;
                sodidata.innerHTML = sstring + document.getElementById("sodslider").value + estring;
                melddata.innerHTML = sstring + document.getElementById("meldcalc").innerHTML + estring;

                row.appendChild(mdate);
                row.appendChild(bildata);
                row.appendChild(creatdata);
                row.appendChild(inrdata);
                row.appendChild(sodidata);
                row.appendChild(melddata);

                table.children[0].appendChild(row);
              }
              function update(id, val){
                id.textContent = val;
              }
              
            </script>
          </div>

          <div class="card">
            <div class="title">EHR Imported Data</div>
            <table id="meastable">
              <tr>
                <th>Date</th>
                <th>Bilirubin</th>
                <th>Creatinine</th>
                <th>INR</th>
                <th>Sodium</th>
                <th>MELD</th>
              </tr>
            </table>
          </div>
          
          <div class="card">
            <div class="title">
              MELD Over Time Based On EHR Data
            </div>
            <button class="annotation-button" id="send2chart">Create Chart Based On Table!</button>
            <script src= 
            "https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"> 
              </script> 
            <script>
              $ (function(){
                document.getElementById("send2chart").addEventListener("click", sendToChart);
                function sendToChart (){
                  var table = document.getElementById("meastable"); 
                  var totalRows = document.getElementById("meastable").rows.length;
                  var totalCol = 6; 
                  
                  //This is converting text entry to basic text
                  for (var x = 1; x < totalRows; x++){
                    for (var y = 0; y < totalCol; y++){
                      if (table.rows[x].cells[y].innerHTML.includes("input type")){
                        var val = table.rows[x].cells[y].innerHTML.substring(72, table.rows[x].cells[y].innerHTML.length-2);
                        //alert("val1 " + val);
                        var val2 = table.rows[x].cells[y].textContent;
                        //alert("val2 " + val2);
                        if (val2 == ""){
                          table.rows[x].cells[y].textContent = val;
                        } else {
                          table.rows[x].cells[y].textContent = val2;
                        }
                      }
                    }
                  }

                  rowcount = document.getElementById("meastable").rows.length-1;
                  colcount = document.getElementById("meastable").rows[0].cells.length
                  google.charts.load('current', {'packages' : [ 'corechart' ]});
                  google.charts.setOnLoadCallback(drawChart);
                  function drawChart() {
                    var data = new google.visualization.DataTable();
                    data.addColumn('date', 'Date');
                    data.addColumn('number', 'MELD Score');
                    data.addRows(rowcount);
                    var table = document.getElementById("meastable"); 
                    for (var i = 1; i < totalRows; i++){
                      for (var j = 0; j < colcount; j++){
                        if (j == 0){
                          data.setCell(i-1, 0, new Date(table.rows[i].cells[j].textContent));
                        }
                        if (j == 5){
                          data.setCell(i-1, 1, parseInt(table.rows[i].cells[j].textContent));
                        }
                      }
                    }

                    var options = {
                      hAxis : {title: 'Date', minValue: new Date(2020,1,1), maxValue: new Date(2020,12,31)},
                      vAxis : {title : 'MELD Score', minValue: 0, maxValue: 40},
                      seriesType: 'scatter',
                      legend : 'none'
                    };

                    var chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));
                    chart.draw(data, options);
                  }
                }
              });
            </script>
            <head>
              <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
              <script type="text/javascript">
                google.charts.load('current', {'packages' : [ 'corechart' ]});
                google.charts.setOnLoadCallback(drawChart);
                function drawChart() {
                var data = google.visualization.arrayToDataTable(
                [
                  ['Date', 'MELD Score'],
                  [new Date(2020, 1, 1), 0],
                ]
                );
                var options = {
                  hAxis : {title: 'Date', minValue: new Date(2020,1,1), maxValue: new Date(2020,12,31)},
                  vAxis : {title : 'MELD Score', minValue: 0, maxValue: 40},
                  seriesType: 'scatter',
                  legend : 'none'
                };
                var chart = new google.visualization.ScatterChart(document.getElementById('chart_div'));
                chart.draw(data, options);
                }
              </script>
            </head>
            <body>
              <div id="chart_div" style="width: 550px; height: 350px;"></div>
            </body>
          </div>
        </div>
      </div>

      </main>
    </div>

    <script src='./lib/js/fhir-client.js'></script>
    <script src="./lib/js/get-data.js"></script>

    <!-- uncomment below script and comment above script to switch for easy local testing -->
    <!-- <script src="./lib/js/get-data-test.js"></script> -->
  </body>

</html>
